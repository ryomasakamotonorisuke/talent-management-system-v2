# 管理者ユーザー作成ガイド

## 🚨 問題が発生した場合の確認事項

管理者ユーザーを作成できない場合、以下の点を確認してください。

### 1. 環境変数の確認

`.env.local`ファイルに以下が設定されているか確認：

```env
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key-here
```

**確認方法：**
- Supabaseダッシュボード → Settings → API
- 「service_role」キーをコピー
- `.env.local`に設定

### 2. 初回管理者ユーザーの作成

システムで初めて管理者ユーザーを作成する場合、まずSupabaseで手動作成する必要があります：

#### ステップ1: Supabaseでユーザーを作成

1. **Supabaseダッシュボード**にアクセス
   - https://supabase.com/dashboard にログイン
   - プロジェクトを選択

2. **「Authentication」→「Users」**をクリック

3. **「Add user」ボタン**をクリック

4. 以下の情報を入力：
   ```
   Email: admin@example.com
   Password: Admin123456（8文字以上、必ずメモ！）
   Auto Confirm User: ✅ ON（絶対にチェック！）
   ```

5. **「Create user」**をクリック

6. 作成されたユーザーの**UUID**をコピー（ユーザーをクリックすると表示されます）

#### ステップ2: usersテーブルに追加

1. **「SQL Editor」**を開く

2. 以下を実行（**UUIDを貼り付け**）：

```sql
-- 組織が存在することを確認（存在しない場合は作成）
INSERT INTO organizations (id, name, is_active)
VALUES (gen_random_uuid(), 'デフォルト組織', true)
ON CONFLICT DO NOTHING;

-- 最初の管理者ユーザーを追加
-- 注意: UUIDとメールアドレスを実際の値に置き換えてください
INSERT INTO users (id, email, name, role, department, is_active)
VALUES (
  'ここにコピーしたUUIDを貼り付け',
  'admin@example.com',
  '管理者',
  'ADMIN',
  '管理部',
  true
);

-- 組織との紐付け
INSERT INTO user_organizations (user_id, organization_id, role)
SELECT 
  u.id,
  o.id,
  'ADMIN'
FROM users u
CROSS JOIN organizations o
WHERE u.email = 'admin@example.com'
  AND o.name = 'デフォルト組織'
LIMIT 1;
```

3. **「Run」**ボタンをクリック

#### ステップ3: ログインして確認

1. アプリケーションのログインページにアクセス
2. 作成したメールアドレスとパスワードでログイン
3. ダッシュボードに「ユーザー管理」カードが表示されることを確認

### 3. 既存管理者から新しい管理者を作成

既に管理者ユーザーでログインしている場合：

1. **ダッシュボード** → **「ユーザー管理」**をクリック
2. **「新規ユーザー作成」**をクリック
3. フォームに必要情報を入力：
   - 所属組織（必須）
   - メールアドレス（必須）
   - パスワード（8文字以上、必須）
   - ロール：「管理部署（フルアクセス）」を選択
   - 氏名、部署（任意）
4. **「ユーザーを作成」**をクリック

### 4. よくあるエラーと対処法

#### エラー: "管理者権限が必要です"

**原因:** 現在ログインしているユーザーが管理者ではありません。

**対処法:**
- 管理者ユーザーでログインし直す
- または、初回管理者ユーザーをSupabaseで手動作成（上記ステップ1-3）

#### エラー: "SUPABASE_SERVICE_ROLE_KEYが設定されていません"

**原因:** 環境変数が設定されていません。

**対処法:**
1. `.env.local`ファイルを確認
2. `SUPABASE_SERVICE_ROLE_KEY`が設定されているか確認
3. 設定されていない場合、Supabaseダッシュボードから取得して設定
4. 開発サーバーを再起動

#### エラー: "このメールアドレスは既に登録されています"

**原因:** 同じメールアドレスのユーザーが既に存在します。

**対処法:**
- 別のメールアドレスを使用
- または、既存のユーザーを削除してから再作成

#### エラー: "組織との紐付けに失敗しました"

**原因:** 選択した組織が存在しないか、アクセス権限がありません。

**対処法:**
1. 組織一覧を確認
2. 有効な組織を選択
3. 組織が存在しない場合、先に組織を作成

### 5. 確認チェックリスト

- ✅ `.env.local`に`SUPABASE_SERVICE_ROLE_KEY`が設定されている
- ✅ 初回管理者ユーザーがSupabaseで作成されている
- ✅ `users`テーブルに管理者レコードが存在する
- ✅ `user_organizations`テーブルに組織との紐付けが存在する
- ✅ 管理者ユーザーでログインできる
- ✅ ダッシュボードに「ユーザー管理」カードが表示される
- ✅ `/dashboard/users`にアクセスできる

### 6. デバッグ方法

問題が解決しない場合：

1. **ブラウザのコンソール（F12）**を開いてエラーメッセージを確認
2. **サーバーのログ**を確認（開発サーバーのターミナル）
3. **Supabaseダッシュボード**の「Logs」→「Auth Logs」を確認
4. **ネットワークタブ**（F12 → Network）でAPIリクエストのレスポンスを確認

## サポート

問題が解決しない場合は、以下を確認してください：
- エラーメッセージの全文
- ブラウザコンソールのエラー
- サーバーログのエラー
- Supabaseダッシュボードのログ





