# 実装状況整理レポート

**作成日**: 2024年  
**対象システム**: 海外技能実習生タレントマネジメントシステム v2.0

---

## 📊 実装状況サマリー

### ✅ 実装済み機能

#### 1. 基本システム構築
- ✅ Next.js 14 (App Router) プロジェクト構成
- ✅ Supabase統合（認証、データベース、ストレージ）
- ✅ TypeScript型定義
- ✅ Tailwind CSS設定
- ✅ 認証ミドルウェア

#### 2. 認証・セキュリティ
- ✅ ログインページ（`/login`）
- ✅ ログアウト機能（`/api/auth/logout`）
- ✅ セッション管理
- ✅ 認証保護（Middleware）

#### 3. 実習生管理機能
- ✅ 実習生一覧ページ（`/dashboard/trainees`）
- ✅ 実習生詳細ページ（`/dashboard/trainees/[id]`）
- ✅ 実習生新規登録（`/dashboard/trainees/new`）
- ✅ 実習生編集（`/dashboard/trainees/[id]/edit`）
- ✅ CSVインポート機能（`/dashboard/trainees/import`）
- ✅ CSVエクスポート機能（`/api/trainees/export`）
- ✅ 写真アップロード機能（Supabase Storage）

#### 4. 検索・フィルタ機能（REQ-002）
- ✅ **実装済み**: 多条件検索機能
  - 名前検索（first_name, last_name, カナ）
  - 実習生ID検索（trainee_id）
  - 国籍フィルタ
  - 部署フィルタ
  - リアルタイムフィルタリング
  - 検索条件リセット機能
- **実装場所**: `src/components/trainees/TraineeSearch.tsx`

#### 5. ダッシュボード
- ✅ 統計情報表示（実習生数、資格数）
- ✅ 国籍別分布グラフ
- ✅ 部署別人数表
- ✅ 資格期限アラート（期限切れ・期限間近）

#### 6. 資格・証明書管理
- ✅ 証明書一覧ページ（`/dashboard/certificates`）
- ✅ 証明書アップロード（`/dashboard/certificates/upload`）
- ✅ 期限切れ・期限間近のアラート表示

#### 7. その他機能
- ✅ スキル評価ページ（`/dashboard/evaluations`）- 表示のみ
- ✅ ユーザー登録ページ（`/dashboard/users/new`）
- ✅ 通知ページ（`/notifications`）- 表示のみ
- ✅ 組織切り替え機能（`OrgSwitcher`コンポーネント）

---

## ❌ 未実装機能（要件定義書より）

### 高優先度（未実装）

#### REQ-001: 権限管理の拡張（人事部・経理部）
**ステータス**: ❌ **未実装**

**詳細**:
- `HR`（人事部）ロールの追加
- `ACCOUNTING`（経理部）ロールの追加
- 型定義に未追加（`src/types/index.ts`の`UserRole`enum）
- データベースの`user_organizations`テーブルの`role`チェック制約に未追加
- RLSポリシーに新ロール対応が未実装

**必要な作業**:
1. `src/types/index.ts`の`UserRole`enumに`HR`と`ACCOUNTING`を追加
2. `docs/database-setup.md`のSQLを更新（`role`チェック制約）
3. RLSポリシーの追加・更新
4. ミドルウェア・各ページコンポーネントでの権限チェック実装

---

#### REQ-005: 手動入力項目の追加（社宅・管理関連情報）
**ステータス**: ❌ **未実装**

**詳細**:
- 監理団体（Supervising Organization）
- 家賃（Monthly Rent）
- 管理会社（Management Company）
- ライフライン契約先（電気・ガス・水道）
- 入寮日（Move-in Date）
- 期（Period / Batch Number）

**必要な作業**:
1. `trainees`テーブルにカラム追加（または新規テーブル`trainee_residence_info`作成）
2. 実習生編集ページに項目追加
3. 権限設定（HR: 編集可能、ACCOUNTING: 家賃・管理会社・ライフラインのみ編集可能）

---

#### REQ-007: 在留期限通知（1ヶ月前）
**ステータス**: ❌ **未実装**

**詳細**:
- 在留期限30日前の自動通知
- 定期実行（Vercel Cron JobsまたはSupabase Edge Functions）
- 通知先: HR、ADMIN、DEPARTMENTユーザー
- 通知タイプ: `VISA_EXPIRY_1MONTH`

**必要な作業**:
1. バッチ処理APIエンドポイント作成（`/api/notifications/check-visa-expiry`）
2. Vercel Cron JobsまたはSupabase Edge Functionsの設定
3. `notifications`テーブルの`type`カラムに`VISA_EXPIRY_1MONTH`追加
4. 通知作成処理の実装

---

### 中優先度（未実装）

#### REQ-006: Google Maps連携
**ステータス**: ❌ **未実装**

**詳細**:
- 社宅住所の横に「地図」ボタンを配置
- Google Mapsで該当地址を表示
- URL: `https://www.google.com/maps/search/?api=1&query={住所}`

**必要な作業**:
1. 実習生詳細ページに「地図」ボタン追加
2. 住所のURLエンコーディング処理
3. 新規タブでGoogle Mapsを開く処理

---

#### REQ-008: 在留期限通知（8ヶ月前）
**ステータス**: ❌ **未実装**

**詳細**:
- 在留期限240日前（8ヶ月前）の通知
- 初級試験対象者である旨を通知
- 通知タイプ: `VISA_EXPIRY_8MONTHS`

**必要な作業**:
1. REQ-007と同様のバッチ処理を拡張
2. 通知タイプ`VISA_EXPIRY_8MONTHS`を追加

---

#### REQ-009: PDF書類管理機能
**ステータス**: ❌ **未実装**

**詳細**:
- 雇用条件書、軽微変更届出書、技能実習計画認定通知書のPDF管理
- 実習生データとの紐づけ
- 書類タイプの管理

**必要な作業**:
1. `certificates`テーブルに`document_type`カラム追加、または新規テーブル`trainee_documents`作成
2. 書類アップロードUIの拡張（`/dashboard/certificates/upload`）
3. 書類タイプの選択機能
4. 書類一覧・ダウンロード機能

---

#### REQ-013: Excel出力機能
**ステータス**: ⚠️ **部分実装**（CSVは実装済み、Excelは未実装）

**詳細**:
- 実習生データのExcel形式（.xlsx）出力
- 現在はCSV出力のみ実装済み（`/api/trainees/export`）

**必要な作業**:
1. Excel生成ライブラリのインストール（`xlsx`または`exceljs`）
2. `/api/trainees/export`を拡張してExcel形式に対応
3. または新規エンドポイント`/api/trainees/export-excel`を作成

---

### 低優先度（外部連携・複雑な機能）

#### REQ-003: 在留カードOCR機能
**ステータス**: ❌ **未実装**（外部API依存）

**詳細**:
- 在留カード画像からの情報自動抽出
- OCR API（Google Cloud Vision API、AWS Textract等）の選定・統合が必要

**必要な作業**:
1. OCRサービスの選定・契約
2. 画像アップロードAPIエンドポイント作成（`/api/trainees/upload-residence-card`）
3. OCR処理API作成（`/api/ocr/residence-card`）
4. データ確認・編集UIの実装
5. `trainees`テーブルにカラム追加（`residence_card_number`, `date_of_birth`, `residence_address`）

---

#### REQ-004: SmartHR連携機能
**ステータス**: ❌ **未実装**（外部API依存）

**詳細**:
- SmartHR入社書類データの自動取り込み
- SmartHR API連携またはCSV/Excelファイルインポート

**必要な作業**:
1. SmartHR API仕様の確認・契約
2. バッチ処理用APIエンドポイント作成（`/api/smarthr/sync`）
3. CSV/Excelパーサーの実装（既存の`/dashboard/trainees/import`を拡張）
4. データマッピング定義
5. `trainee_smarthr_sync`テーブル作成（同期履歴管理）

---

#### REQ-010: 事業所責任者一覧取り込み
**ステータス**: ❌ **未実装**

**詳細**:
- 人事部作成の事業所責任者一覧のインポート
- Excel/CSVファイルアップロード

**必要な作業**:
1. インポートページ作成（`/dashboard/departments/import-managers`）
2. Excel/CSVパーサーの実装
3. インポートAPIエンドポイント作成（`/api/departments/import-managers`）
4. `department_managers`テーブル作成

---

#### REQ-011: 事業所住所一覧取り込み
**ステータス**: ❌ **未実装**

**詳細**:
- 経営企画部作成の事業所住所一覧のインポート
- 事業所番号、AM（アカウントマネージャー）名の反映

**必要な作業**:
1. インポートページ作成（`/dashboard/departments/import-addresses`）
2. Excel/CSVパーサーの実装
3. インポートAPIエンドポイント作成（`/api/departments/import-addresses`）
4. `departments`テーブルにカラム追加（`office_number`, `address`, `account_manager`）

---

#### REQ-012: 指導員登録機能
**ステータス**: ❌ **未実装**

**詳細**:
- 技能実習指導員と生活指導員の登録
- 指導員一覧の表示

**必要な作業**:
1. `instructors`テーブル作成
2. 指導員登録ページ作成（`/dashboard/instructors/new`）
3. 指導員一覧ページ作成（`/dashboard/instructors`）
4. 指導員編集ページ作成（`/dashboard/instructors/[id]/edit`）

---

#### REQ-014: 宛名ラベル作成機能
**ステータス**: ❌ **未実装**

**詳細**:
- 宛名ラベル作成用Excelファイルの生成・ダウンロード
- 実習生の名前、住所、郵便番号を含む

**必要な作業**:
1. Excel生成ライブラリの使用
2. 宛名ラベル用APIエンドポイント作成（`/api/trainees/export-labels`）
3. 実習生一覧または詳細ページに「宛名ラベル作成」ボタンを追加

---

## 📋 これからの課題（優先順位順）

### 🔴 最優先（高優先度）

1. **REQ-001: 権限管理の拡張**
   - HR・ACCOUNTINGロールの追加
   - 型定義・データベーススキーマの更新
   - RLSポリシーの実装
   - 権限チェックの実装

2. **REQ-005: 手動入力項目の追加**
   - 社宅・管理関連情報の入力項目追加
   - データベーススキーマの拡張
   - 編集ページの拡張

3. **REQ-007: 在留期限通知（1ヶ月前）**
   - バッチ処理の実装
   - 定期実行の設定（Vercel Cron Jobs）
   - 通知システムの拡張

### 🟡 中優先度

4. **REQ-006: Google Maps連携**
   - 実装が比較的簡単（外部API不要）
   - ユーザー体験向上

5. **REQ-008: 在留期限通知（8ヶ月前）**
   - REQ-007の拡張として実装可能

6. **REQ-009: PDF書類管理**
   - 既存の証明書管理機能を拡張

7. **REQ-013: Excel出力機能**
   - CSV出力機能を拡張

### 🟢 低優先度（外部連携・複雑な機能）

8. **REQ-003: 在留カードOCR機能**
   - 外部API契約が必要
   - コスト・精度の検討が必要

9. **REQ-004: SmartHR連携**
   - SmartHR API仕様の確認・契約が必要

10. **REQ-010: 事業所責任者一覧取り込み**
11. **REQ-011: 事業所住所一覧取り込み**
12. **REQ-012: 指導員登録機能**
13. **REQ-014: 宛名ラベル作成機能**

---

## 📝 技術的メモ

### 実装済みの技術スタック
- Next.js 14 (App Router)
- React 18
- TypeScript
- Supabase (Auth, Database, Storage)
- Tailwind CSS
- Vercel（デプロイ準備済み）

### 追加が必要な依存関係
- `xlsx` または `exceljs`（Excel出力用）
- OCRサービス（REQ-003実装時）
- SmartHR API SDK（REQ-004実装時）

---

## 🎯 次のアクション

### 即座に着手すべき項目
1. **REQ-001**: 権限管理の拡張（HR・ACCOUNTINGロール）
2. **REQ-005**: 社宅・管理関連情報の入力項目追加
3. **REQ-007**: 在留期限通知システムの構築

### 検討が必要な項目
- REQ-003: OCRサービスの選定・契約
- REQ-004: SmartHR API仕様の確認・契約

---

**最終更新日**: 2024年  
**次回レビュー推奨日**: 機能実装完了時


